<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body bgcolor="black">
        <button style="border: 1px solid green; background-color: black; color: green" onclick="DeviceMotionEvent.requestPermission()">GYRO</button>
        <pre id="output" style="color: hsla(120, 100%, 25%, 1); font-size: 20px;"></pre>
        <pre id="debug" style="color: hsla(120, 100%, 25%, 1)"></pre>
        <font style="color: hsla(120, 100%, 25%, 1)">ball speed:</font><input type="number" min="1" max="100" value="90" id="speed" style = "color:green; background-color: black;">
        <font style="color: hsla(120, 100%, 25%, 1)">ball gravity:</font><input type="number" min="1" max="100" value="700" id="gravity" style = "color:green; background-color: black;">

        <script>

            var prevX = 0
            var prevY = 0

            setInterval(() => {
                //energy = 0
            }, 100)

            onmousemove = (event) => {
                ev = {}
                ev.acceleration = {}
                const x = event.clientX / 1000
                const y = event.clientY / 1000
                ev.acceleration.x = event.clientX - prevX
                ev.acceleration.y = event.clientY - prevY
                ev.acceleration.z = 0
                prevX = x
                prevY = y
                ondevicemotion(ev)
            }

            var prev = [0,0,0]
            var energy = 0.001
            
            var energyThreshold = 0.05
            var minEnergy = 0.0
            var energyScale = 1.0
            
            ondevicemotion = (event) => {
            
                var [x, y, z] = [event.acceleration.x, event.acceleration.y, event.acceleration.z]
                var [dx, dy, dz] = [x - prev[0], y - prev[1], z - prev[2]]
                prev = [x, y, z]
                var [x, y, z] = [dx, dy, dz]
                energy = energyScale * (dx * dx + dy * dy + dz * dz)
                if (energy > energyThreshold) {
                    energy = energyThreshold
                }
                
            
            }
            setInterval(() => {
                energy = 0
            }, 300)
        </script>
        <script>

            var speedFactor = 1.0
            var gravityFactor = 1.0

            setInterval(() => {  
                if (document.getElementById("speed").value > 0 && document.getElementById("gravity").value > 0) {
                    speedFactor = 2 * document.getElementById("speed").value / 100
                    gravityFactor = 2 * document.getElementById("gravity").value / 100
                }

            }, 100)




            const maxy = 755
            const maxrate = 40
            var rate = 0
            var cursor = 0

            var y = maxy
            var console = []

            const alphabet = "01234567890abcdefghijklmnopqrstuvwxyzâ–¡".split('')

            const template = ["_", "_", "<", "<", "<", "<", "<", "<", "<", "<", "_"].concat(alphabet)
            var set = template
            var candidate = ""
            var out = ""

            setInterval(() => {     
                const gravity = gravityFactor * 2 / 10
                const shift = (y - (energy * 300 * speedFactor))
                y1 = Math.max(0, Math.min(maxy, (shift + gravity)))

                if (y1 < y) {
                    y = y1 
                } else {
                    y = y1 + gravity * (0.3 * 1000 / shift)
                }

                if (y > maxy) {
                    y = maxy
                }

                if (y < 0) {
                    y = 0
                }
                rate = (y) / maxy
            }, 10)

            var i = 0
            var rangeStart = 0
            var rangeEnd = set.length
            var prevPeriod = 0
            setInterval(() => {
                const period = rate == 0 ? maxrate : Math.round(1 / rate)
                const periodFactor = (1 / period)
                const range = Math.round(periodFactor * set.length)

                if (Math.abs(prevPeriod - period) > 0) {
                    rangeStart = (Math.round(cursor / range) * range) % (set.length - range - 1)
                    rangeEnd = rangeStart + range
                }
                

                i++
                i %= (period * 10)
                if (i == 0) {
                    cursor ++
                }

                cursor %= set.length

                if (cursor > rangeEnd) {
                    cursor = rangeStart
                }     

                if (cursor < rangeStart) {
                    cursor = rangeStart
                }  

                candidate = set[cursor]
   
                if (period > 30) {
                    if (candidate === "<") {
                        console.pop()
                    } else if (candidate === "_") {
                        
                    } else {
                        console.push(candidate)
                    }
                    
                    y = 0
                    rate = 1
                    energy = 0
                    cursor = 0
                }

                const style  = `color: hsla(120, ${100}%, ${
                    10 + period * 90 / 30
                }%, 1); font-size: ${20 + period / 10}px; dominant-baseline: middle`
                out = "\n" + (console.length == 0 ? '' : console.reduce((a, b) => a + b)) + `<font style="${style}">${candidate}</font>` 
                
                document.getElementById("output").innerHTML = out
                document.getElementById("debug").innerHTML = `\n\n\n\n\n\n        [${'|'.repeat(25 - y / 30)}${' '.repeat(y / 30)}]` + `\n\n\n\n\n\nperiod = ${period}, cursor = ${cursor}, i = ${i}, \n range = ${range}, rangeStart = ${rangeStart}, rangeEnd = ${rangeEnd}, \n speedFactor = ${speedFactor}, gravityFactor = ${gravityFactor}`

                prevPeriod = period
            }, 10)

        </script>
    </body>
</html>